#!/usr/bin/env modbuild

pbuild::configure() {
	cat <<EOF > "${SRC_DIR}/make.inc"
SHELL = /bin/sh
PLAT = 
DRVOPTS  = \$(OPTS)
LOADER   = \$(FORTRAN) -pthread
ARCHFLAGS= -ru
EOF
	cat <<EOF > "${SRC_DIR}/Makefile.rule"
VERSION = 0.2.9
TARGET = CORE2
CC = gcc
BINARY=64
USE_THREAD = 1
USE_OPENMP = 1
NO_SHARED = 1
NO_WARMUP = 1
NO_AFFINITY = 1
FCOMMON_OPT = -frecursive
COMMON_PROF = -pg
EOF
}

pbuild::compile() {
	cd "${SRC_DIR}"
	make
}

pbuild::install() {
	make PREFIX="${PREFIX}" install
	# We have to build shared libs and remove them here.
	# Building with NOSHARED gives an error during install -
	# due to a bug in the Makefile(s).
	rm -f "${PREFIX}/lib/"*.so
	rm -f "${PREFIX}/lib/"*.dylib 
	#( cd "${PREFIX}/lib"; ln -fs
}

pbuild::add_to_group 'Compiler'
pbuild::set_docfiles 'LICENSE' 'README.md'
pbuild::set_supported_compilers 'gcc'
pbuild::make_all
pbuild::cleanup_src
