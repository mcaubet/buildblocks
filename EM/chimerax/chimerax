#!/bin/bash
set -e

export LANG=C.UTF-8
export LC_ALL=C.UTF-8

if [[ -z "$APPTAINER_IMAGE" || ! -f "$APPTAINER_IMAGE" || "${APPTAINER_IMAGE##*.}" != "sif" ]]; then
    echo "Error: Valid Apptainer (.sif) image not found."
    exit 1
fi

BIND_OPTS=(
    --bind "/data/scratch/shared:/data/scratch/shared"
    --bind "/data/user:/data/user"
    --bind "/data/project:/data/project"
    --bind "/scratch:/scratch"
    --bind "/tmp:/tmp"
    --bind "/etc/ssl/ca-bundle.pem:/etc/ssl/ca-bundle.pem"
)

if command -v nvidia-smi &>/dev/null && nvidia-smi &>/dev/null; then
    echo "NVIDIA GPU detected — running with --nv"
    singularity exec --nv "${BIND_OPTS[@]}" \
        "$APPTAINER_IMAGE" vglrun +v -d egl /usr/bin/chimerax "$@"
else
    echo "No NVIDIA GPU detected — running CPU-only"
    singularity exec "${BIND_OPTS[@]}" \
        "$APPTAINER_IMAGE" /usr/bin/chimerax "$@"
fi
