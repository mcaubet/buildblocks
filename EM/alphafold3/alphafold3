#!/bin/bash
set -euo pipefail

# Function to extract a flag value
get_arg_value() {
    local name="$1"
    shift
    for arg in "$@"; do
        if [[ "$arg" == "$name="* ]]; then
            echo "${arg#*=}"
            return
        fi
    done
}

# Validate that the AlphaFold3 image is specified and exists
if [[ -z "${APPTAINER_IMAGE:-}" || ! -f "$APPTAINER_IMAGE" ]]; then
    echo "Error: AlphaFold3 image not found or is not set."
    echo "Please contact the system administrators for assistance."
    exit 1
fi

IMAGE="$APPTAINER_IMAGE"

# Parse and handle help flags
SHOW_HELP_SHORT=false
SHOW_HELP_FULL=false

for arg in "$@"; do
    case "$arg" in
        --help|--helpshort)
            SHOW_HELP_SHORT=true
            ;;
        --helpfull)
            SHOW_HELP_FULL=true
            ;;
    esac
done

if $SHOW_HELP_SHORT; then
    singularity exec "$IMAGE" python /app/alphafold/run_alphafold.py --help
    exit 0
fi

if $SHOW_HELP_FULL; then
    singularity exec "$IMAGE" python /app/alphafold/run_alphafold.py --helpfull
    exit 0
fi

# Require --json_path
if [[ "$*" != *"--json_path="* ]]; then
    echo "Error: You must provide --json_path=<path_to_input_json>"
    echo "Run 'alphafold3 --help' or 'alphafold3 --helpfull' for usage."
    exit 1
fi

# Extract relevant arguments
JSON_PATH=$(get_arg_value "--json_path" "$@")
OUTPUT_PATH=$(get_arg_value "--output_dir" "$@")
USER_MODEL_DIR=$(get_arg_value "--model_dir" "$@")
USER_DB_DIR=$(get_arg_value "--db_dir" "$@")

# Validate JSON input file
if [[ ! -f "$JSON_PATH" ]]; then
    echo "Error: Input file '$JSON_PATH' not found."
    exit 1
fi

# Set default output directory
OUTPUT_PATH="${OUTPUT_PATH:-.}"
mkdir -p "$OUTPUT_PATH"

# Convert paths to absolute
JSON_PATH_ABS=$(readlink -f "$JSON_PATH")
JSON_DIR_ABS=$(dirname "$JSON_PATH_ABS")
JSON_FILE_NAME=$(basename "$JSON_PATH_ABS")
OUTPUT_PATH_ABS=$(readlink -f "$OUTPUT_PATH")

# Ensure model directory is provided
if [[ -z "${USER_MODEL_DIR:-}" ]]; then
    echo "Error: You must provide --model_dir=<path_to_model_dir>"
    exit 1
fi
MODEL_DIR_ABS=$(readlink -f "$USER_MODEL_DIR")

# Use user-provided or default database directory
if [[ -n "${USER_DB_DIR:-}" ]]; then
    DB_DIR="$USER_DB_DIR"
else
    DB_DIR="${PUBLIC_DATABASES_DIR:-}"
    if [[ -n "$DB_DIR" ]]; then
        echo "Info: --db_dir not provided. Using default public database at: $DB_DIR"
    fi
fi

# Validate that the chosen database directory exists
if [[ -z "$DB_DIR" || ! -d "$DB_DIR" ]]; then
    echo "Error: Valid database directory not provided."
    echo "Set --db_dir=<path_to_db_dir> or contact the system administrators for assistance."
    exit 1
fi

DB_DIR_ABS=$(readlink -f "$DB_DIR")

# Clean arguments: remove ones that are handled by the wrapper
CLEANED_ARGS=()
for arg in "$@"; do
    case "$arg" in
        --json_path=*|--output_dir=*|--model_dir=*|--db_dir=*)
            # Skip these since they're replaced with internal paths
            ;;
        *)
            CLEANED_ARGS+=("$arg")
            ;;
    esac
done

# Run AlphaFold inside the Singularity container
singularity exec \
    --nv \
    --bind "$JSON_DIR_ABS:/root/af_input" \
    --bind "$OUTPUT_PATH_ABS:/root/af_output" \
    --bind "$MODEL_DIR_ABS:/root/models" \
    --bind "$DB_DIR_ABS:/root/public_databases" \
    "$IMAGE" \
    python /app/alphafold/run_alphafold.py \
        --json_path="/root/af_input/$JSON_FILE_NAME" \
        --output_dir="/root/af_output" \
        --model_dir="/root/models" \
        --db_dir="/root/public_databases" \
        "${CLEANED_ARGS[@]}"
