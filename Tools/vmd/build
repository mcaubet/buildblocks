#!/usr/bin/env modbuild

pbuild::pre_configure() {
   echo "> Setting system flags"
   case "$(uname -m)" in
       aarch64)
           export CC=gcc
           export CXX=g++
           export CFLAGS='-march=native -O3 -pipe -Wno-error'
           export CXXFLAGS='-march=native -O3 -pipe -Wno-error'
           export FFLAGS='-march=native -O3 -pipe'
           export FCFLAGS='-march=native -O3 -pipe'
           export LDFLAGS='-Wl,--as-needed'
           ;;
       x86_64)
           export CC=gcc
           export CXX=g++
           export CFLAGS='-march=znver2 -mtune=znver2 -O3 -pipe -Wno-error'
           export CXXFLAGS='-march=znver2 -mtune=znver2 -O3 -pipe -Wno-error'
           export FFLAGS='-march=znver2 -mtune=znver2 -O3 -pipe'
           export FCFLAGS='-march=znver2 -mtune=znver2 -O3 -pipe'
           export LDFLAGS='-Wl,--as-needed'
           export CFLAGS='-march=znver2 -mtune=znver2 -O3 -pipe -Wno-error'
           ;;
   esac
}

pbuild::configure() {
    # Set dependencies versions and directories
    : "${TCL_VERSION:=8.6.14}"
    : "${TK_VERSION:=8.6.14}"
    : "${BIN_ARCH:=LINUXAMD64}"

    # Untar VMD
    wget https://www.ks.uiuc.edu/Research/${P}/alpha/${P}-${V}.bin.${BIN_ARCH}.tar.gz -O "${BUILD_DIR}/${P}-${V}.bin.${BIN_ARCH}.tar.gz"
    tar xzf "${BUILD_DIR}/${P}-${V}.bin.${BIN_ARCH}.tar.gz" --strip-components=1
    cd "${BUILD_DIR}"

    ####################
    # TCL
    ####################
    wget http://prdownloads.sourceforge.net/tcl/tcl${TCL_VERSION}-src.tar.gz
    tar xzf tcl${TCL_VERSION}-src.tar.gz
    mv tcl${TCL_VERSION} tcl
    cd tcl/unix
    ./configure --prefix=$(pwd)/.. --enable-shared --enable-threads
    make -j 8
    make install
    cd ../..

    ####################
    # TK
    ####################
    wget http://prdownloads.sourceforge.net/tcl/tk${TK_VERSION}-src.tar.gz
    tar xzf tk${TK_VERSION}-src.tar.gz
    mv tk${TK_VERSION} tk
    cd tk/unix
    ./configure --prefix=$(pwd)/.. --enable-shared --enable-threads
    make -j 8
    make install
    cd ../..
}

pbuild::compile() {
    :
}

pbuild::install() {
    rsync -lr "${BUILD_DIR}/" "${PREFIX}"
    cd "${PREFIX}/bin"
    ln -s ../${BIN_ARCH}/${P}_${BIN_ARCH} ${P}
}
